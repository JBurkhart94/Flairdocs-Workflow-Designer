@model Flairdocs_Workflow_Designer.Models.Workflow

@{
    ViewBag.Title = "Workflow";
}


<div data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="design:'sidebar', gutters:false, liveSplitters:true" id="borderContainer">





    <div data-dojo-type="dijit/layout/ContentPane" data-dojo-props="splitter:true, region:'top'" style="width: 100px; overflow-y: auto">
        <div id="flairdocs-banner">
            <img src="~/Content/flairsoft-logo.png" alt="Flairdocs" />
        </div>
        <div id="workflow-designer-top-wrapper">
            <div id="workflow-designer-menu">
                <select class="workflow-live-search" data-placeholder="Search Workflow">
                    @{
                        foreach (string title in ViewBag.Titles)
                        {
                            <option>@title</option>
                        }
                    }
                </select>
                <button id="open-workflow-button" type="button"><span class="glyphicon glyphicon-folder-open"></span>Open Workflow</button>
                <button id="create-workflow-button" type="button"><span class="glyphicon glyphicon-plus"></span>Create Workflow</button>
                <button id="workflow-audit-log-button" type="button"><span class="glyphicon glyphicon-list-alt"></span>Audit Log</button>
                <button id="workflow-settings-button" type="button"><span class="glyphicon glyphicon-cog"></span>Workflow Settings</button>
                <div id="workflow-description">
                    <i>@Model.Description</i>
                </div>
            </div>
            <div id="workflow-designer-window">
                <div id="workflow-designer-window-buttons">
                    <button id="add-reviewer-button" type="button"><span class="glyphicon glyphicon-move"></span>Drag to add Reviewer</button>
                    <button id="save-workflow-button" type="button"><span class="glyphicon glyphicon-floppy-disk" onclick="'@Url.Action("Save", "Home")'"></span>Save</button>
                </div>
                <div id="workflow-designer-window-edit">
                    @{
                        if (Model.Steps.Count() == 0)
                        {
                            <div class="workflow-step" value="00000000-0000-0000-0000-000000000000"></div>
                        }
                        else
                        {
                            foreach (var step in Model.Steps)
                            {
                                <div class="workflow-step" value="@step.Id"></div>
                            }
                        }
                    }

                    <div id="add-step-button" class="glyphicon glyphicon-chevron-right"></div>
                </div>
            </div>
        </div>
    </div>







    <div data-dojo-type="dijit/layout/ContentPane" data-dojo-props="splitter:true, region:'center'">

    </div>
</div>

<style>
    html, body {
        width: 100%;
        height: 100%;
        margin: 0;
    }

    #borderContainer {
        width: 100%;
        height: 100%;
        overflow: auto;
    }

    #workflow-description {
        width: 170px;
        margin-left: auto;
        margin-right: auto;
        margin-top: 15px;
        max-height: 100px;
        overflow: auto;
        font-weight: 100;
    }
</style>

<script>
    require(["dojo/parser", "dijit/layout/ContentPane", "dijit/layout/BorderContainer"]);
    var steps = @Model.Steps.Count();
    var title = "default";
    var description = "default";

    $(document).ready(function () {
        $('#add-step-button').click(addStep);
        $('#create-workflow-button').click(create_work_flow);
        $('#save-workflow-button').click(save_workflow);
        $("#open-workflow-button").click(open_workflow);
        // select2 Setup
        $('.workflow-live-search').select2({
            allowClear: true,
            multiple: false,
            width: '200px',
            theme: 'classic',
            // used to toggle search box
            dropdownAutoWidth: true,
            closeOnSelect: true,
            //dropdownParent: $('.workflow-live-search')
        });
        // reset selection

        $('.workflow-live-search').val('').change();
    });
    function open_workflow() {
        if ($('.workflow-live-search').select2('data')[0].text != "") {
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", '@Url.Action("WorkflowSearch", "Home")?title=' + $('.workflow-live-search').select2('data')[0].text, true);
            xhttp.send();
            xhttp.onreadystatechange = function () {
                if (xhttp.readyState == 4 && xhttp.status == 200 && xhttp.response != null) {
                      var url = '@Url.Action("Workflow", "Home")?id=' + xhttp.response;
                      window.location.href = url;
                }
            }
        }
    }
    function save_workflow() {
        $('.workflow-step').each(function (index) {
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", '@Url.Action("SaveStep", "Home")?workflowId=@Model.Id' + "&stepId=" + $(this).attr('value') + "&order=" + index, true);
            xhttp.send();
            xhttp.onreadystatechange = function () {
                if (xhttp.readyState == 4 && xhttp.status == 200) {
                    console.log("Saved step " + index);
                    $(this).value = xhttp.response;
                }
            }
        });
    }
    function create_work_flow() {
        swal.setDefaults(
            {
                width: '30%',
                confirmButtonColor: '#2db300',
                cancelButtonColor: 'red',

            }
        );
        var q = [
            {
                progressSteps: ['1', '2'],
                showCancelButton: true,
                title: 'Workflow Title',
                input: 'text',
                confirmButtonText: 'Next',
                inputValidator: function (value) {
                    return new Promise(function (resolve, reject) {
                        if (value) {
                            var xhttp = new XMLHttpRequest();
                            xhttp.open("GET", '@Url.Action("TitleExists", "Home")?title=' + value, true);
                            xhttp.send();
                            xhttp.onreadystatechange = function () {
                                if (xhttp.readyState == 4 && xhttp.status == 200) {
                                    console.log(xhttp.response);
                                    if (xhttp.response == "False") {
                                        title = value;
                                        resolve();
                                    } else {
                                        reject("Workflow " + value + " already exists!");
                                    }

                                }
                            }
                        } else {
                            reject("Workflow title cannot be empty! ");
                        }
                    }
                    )
                }
            },
            {
                progressSteps: ['1', '2'],
                showCancelButton: true,
                title: 'Workflow Description',
                input: 'textarea',
                confirmButtonText: 'Done',
                inputValidator: function (value) {
                    return new Promise(function (resolve, reject) {
                        if (value) {
                            description = value;
                            resolve()
                        } else {
                            reject("Workflow Descriptions cannot be empty! ")
                        }
                    }
                    )
                }
            }
        ];
        swal.queue(q).then(function () {
            //Once successful, create the new workflow and redirect to its editable page
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", '@Url.Action("Create", "Home")?title=' + title + '&description=' + description, true);
            xhttp.send();
            xhttp.onreadystatechange = function () {
                if (xhttp.readyState == 4 && xhttp.status == 200 && xhttp.response != null) {
                    console.log("Received Response From Create: " + xhttp.response);
                    var url = '@Url.Action("Workflow", "Home")?id=' + xhttp.response;
                    console.log("Redirect url: " + url);
                    console.log(xhttp.response);
                    window.location.href = url;
                }
            }
        });

    }

    function addStep(e) {
        steps += 1;
        var code = '<div class="workflow-step" value="00000000-0000-0000-0000-000000000000"></div >';
        $(code).insertBefore('#add-step-button');
        var tag = $('#workflow-designer-window-edit');
        tag.scrollLeft(350 * steps);
        console.log("testing");
    }


    function resetWorkflow() {
        console.log("Resetting workflow");
        $("#workflow-designer-window-edit").html('<div id="add-step-button" class="glyphicon glyphicon-chevron-right"></div>');
        $('#add-step-button').click(addStep);
        addStep();
        steps = 1;
    }

    //Warn the user that unsaved changes will be lost when refreshing
    window.onbeforeunload = function () {
        return "Any unsaved data will be lost.  Are you sure you wish to refresh?";
    }
</script>
